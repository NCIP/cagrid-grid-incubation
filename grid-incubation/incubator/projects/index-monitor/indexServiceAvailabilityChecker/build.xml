<?xml version="1.0"?>

<!-- ================================================================= -->
<!-- Index Service Deploy build file                                   -->
<!-- ================================================================= -->

<project name="IndexServiceAvailabilityChecker" default="compile" basedir=".">

	<!-- Define the environment variable -->
	<property environment="env" />

	<!-- Important directories and files -->
	<property name="src.dir" location="src" />
	<property name="lib.dir" location="lib" />

	<!-- Basic Build directories -->

	<!-- Auxiliary directory where all the intermediate files will be placed -->
	<property name="build.dir" location="build" />
	<!-- Directory for compiled service classes -->
	<property name="build.dest" location="${build.dir}/classes" />


	<!-- =============================================================== -->
	<!-- Deploy the Index Service to a JBoss container                   -->
	<!-- =============================================================== -->
	<target name="deployJBoss" description="Deploy the index service to a JBoss container">
		<fail unless="env.JBOSS_HOME"
			  message="Cannot deploy to JBOSS unless environment variable JBOSS_HOME is defined" />
	</target>

	<!-- ================================================================================= -->
	<!-- Deploy the index service availability checker application to a tomcat container.  -->
	<!-- ================================================================================= -->
	<target name="deployTomcat" description="Deploy the index service to a tomcat container">
		<fail unless="env.CATALINA_HOME"
			  message="Cannot deploy to tomcat unless environment variable CATALINA_HOME is defined" />
	</target>



	<!-- ============================================================== -->
	<!-- Globus properties                                              -->
	<!-- ============================================================== -->
	<target name="checkGlobus" depends="setGlobus">
		<condition property="globus.not.found">
			<or>
				<not>
					<isset property="ext.globus.dir" />
				</not>
				<equals arg1="${ext.globus.dir}" arg2="" />
			</or>
		</condition>
		<fail message="Globus installation is not set in either GLOBUS_LOCATION or ext.globus.dir" if="globus.not.found" />
		<echo message="Globus: ${ext.globus.dir}" />
	</target>
	<target name="setGlobus" if="env.GLOBUS_LOCATION">
		<!-- GT4 build files and directories-->
		<property name="ext.globus.dir" value="${env.GLOBUS_LOCATION}" />
		<property name="build.stubs" location="build-stubs.xml" />
		<property name="schema.src" location="${ext.globus.dir}/share/schema" />
		<property name="build.packages" location="${ext.globus.dir}/share/globus_wsrf_common/build-packages.xml" />
		<!-- Copied from build.stubs file, as there is no way to "append" to the value in the remote file -->
		<property name="GT4.ns.excludes" value="-x http://docs.oasis-open.org/wsrf/2004/06/wsrf-WS-BaseFaults-1.2-draft-01.xsd -x http://docs.oasis-open.org/wsrf/2004/06/wsrf-WS-BaseFaults-1.2-draft-01.wsdl -x http://docs.oasis-open.org/wsrf/2004/06/wsrf-WS-ResourceLifetime-1.2-draft-01.xsd -x http://docs.oasis-open.org/wsrf/2004/06/wsrf-WS-ResourceLifetime-1.2-draft-01.wsdl -x http://docs.oasis-open.org/wsrf/2004/06/wsrf-WS-ResourceProperties-1.2-draft-01.xsd -x http://docs.oasis-open.org/wsrf/2004/06/wsrf-WS-ResourceProperties-1.2-draft-01.wsdl -x http://docs.oasis-open.org/wsrf/2004/06/wsrf-WS-ServiceGroup-1.2-draft-01.xsd -x http://docs.oasis-open.org/wsrf/2004/06/wsrf-WS-ServiceGroup-1.2-draft-01.wsdl -x http://docs.oasis-open.org/wsn/2004/06/wsn-WS-BaseNotification-1.2-draft-01.xsd -x http://docs.oasis-open.org/wsn/2004/06/wsn-WS-BaseNotification-1.2-draft-01.wsdl -x http://schemas.xmlsoap.org/ws/2004/04/trust -x http://schemas.xmlsoap.org/ws/2002/12/policy -x http://schemas.xmlsoap.org/ws/2002/07/utility -x http://schemas.xmlsoap.org/ws/2004/04/sc -x http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-secext-1.0.xsd -x http://www.w3.org/2000/09/xmldsig# -x http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-utility-1.0.xsd -x http://schemas.xmlsoap.org/ws/2004/09/enumeration" />
	</target>

	<!-- Sets up the build directory structure -->
	<target name="init" depends="checkGlobus">
		<mkdir dir="${build.dir}" />
		<mkdir dir="${build.dest}" />
	</target>

	<!-- - - - - - - - - - - - - - - - - - 
          target: compile                      
         - - - - - - - - - - - - - - - - - -->
	<target name="compile" depends="init" description="Compile the java code.">
		<javac srcdir="${src.dir}" classpathref="${lib.dir}" includes="**" destdir="${build.dest}" debug="${java.debug}" />
	</target>

	<!-- ================================= 
          target: deployIndexMonitorTomcat              
         ================================= -->
    <target name="deployIndexMonitorTomcat" depends="compile,deployTomcat" description="Deploy the index service and its monitoring service to a tomcat container.">
        <ant antfile="${basedir}/deploy-redirect.xml" target="deployRedirect">
        	<property name="deploy.dir" value="${env.CATALINA_HOME}/webapps/wsrf/WEB-INF"/>
        	<property name="startScript.unix" location="${env.CATALINA_HOME}/bin/startup.sh"/>
        	<property name="startScript.windows" location="${env.CATALINA_HOME}/bin/startup.bat"/>	
        	<property name="stopScript.unix" location="${env.CATALINA_HOME}/bin/shutdown.sh"/>
        	<property name="stopScript.windows" location="${env.CATALINA_HOME}/bin/shutdown.bat"/>	
        </ant>
    </target>

	<!-- ================================= 
          target: deployIndexMonitorJBoss              
         ================================= -->
    <target name="deployIndexMonitorJBoss" depends="compile,deployTomcat" description="Deploy the index service and its monitoring service to a JBoss container.">
        <ant antfile="${basedir}/deploy-redirect.xml" target="deployRedirect">
        	<property name="deploy.dir" value="${env.JBOSS_HOME}/server/default/deploy/wsrf.war/WEB-INF"/>
        	<property name="startScript.unix" location="${env.JBOSS_HOME}/bin/run.sh"/>
        	<property name="startScript.windows" location="${env.JBOSS_HOME}/bin/run.bat"/>	
        	<property name="stopScript.unix" location="${env.JBOSS_HOME}/bin/shutdown.sh"/>
        	<property name="stopScript.windows" location="${env.JBOSS_HOME}/bin/shutdown.bat"/>	
        </ant>
    </target>

</project>